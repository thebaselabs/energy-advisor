    <script>
        // ENHANCED ENERGY REPLENISHMENT ADVISOR WITH GEMINI AI
        (function(){
            'use strict';
            
            // üîë GEMINI AI Configuration - ADD YOUR API KEY HERE
            const GEMINI_API_KEY = 'AIzaSyCkvs2bymUIREi03cJsse8dyL2c2NgYGy0'; // ADD YOUR GEMINI API KEY HERE
            
            let currentCaloriesBurned = 0;
            let currentReplenishmentCalories = 0;
            let currentActivityCategory = null;
            let userProfile = {};
            let userPreferences = {
                dietary: 'any',
                timing: 'immediate',
                goal: 'recovery',
                allergies: []
            };
            let aiFoodCategories = {
                quick_energy: [],
                protein_rich: [],
                balanced: [],
                full_meals: []
            };
            
            const elements = {
                // Profile inputs
                userWeight: document.getElementById('user-weight'),
                userAge: document.getElementById('user-age'),
                userGender: document.getElementById('user-gender'),
                fitnessLevel: document.getElementById('fitness-level'),
                
                // Activity inputs
                customActivity: document.getElementById('custom-activity'),
                analyzeBtn: document.getElementById('analyze-btn'),
                btnText: document.querySelector('.btn-text'),
                
                // Personalization inputs
                personalizationPanel: document.getElementById('personalization-panel'),
                dietaryPreference: document.getElementById('dietary-preference'),
                eatingTiming: document.getElementById('eating-timing'),
                foodGoal: document.getElementById('food-goal'),
                personalizeBtn: document.getElementById('personalize-btn'),
                
                // Results
                aiAnalysis: document.getElementById('ai-analysis'),
                aiRecommendation: document.getElementById('ai-recommendation-text'),
                macroBreakdown: document.getElementById('macro-breakdown'),
                caloriesResult: document.getElementById('calories-result'),
                caloriesBurned: document.getElementById('calories-burned'),
                weightGoal: document.getElementById('weight-goal'),
                replenishPercent: document.getElementById('replenish-percent'),
                getRecommendationsBtn: document.getElementById('get-recommendations-btn'),
                clearActivitiesBtn: document.getElementById('clear-activities-btn'),
                foodRecommendations: document.getElementById('food-recommendations'),
                foodHeader: document.getElementById('food-header'),
                foodResults: document.getElementById('food-results'),
                foodCategories: document.getElementById('food-categories'),
                
                // Error messages
                weightError: document.getElementById('weight-error'),
                ageError: document.getElementById('age-error'),
                genderError: document.getElementById('gender-error'),
                fitnessError: document.getElementById('fitness-error'),
                activityError: document.getElementById('activity-error')
            };

            function initApp() {
                setupEventListeners();
            }

            function setupEventListeners() {
                elements.analyzeBtn.addEventListener('click', analyzeActivityWithAI);
                elements.getRecommendationsBtn.addEventListener('click', showPersonalizationPanel);
                elements.personalizeBtn.addEventListener('click', applyPersonalizationAndShowFoods);
                elements.clearActivitiesBtn.addEventListener('click', clearAll);
                elements.foodCategories.addEventListener('click', handleCategoryFilter);
            }

            function validateUserProfile() {
                let isValid = true;
                
                // Reset errors
                elements.weightError.classList.remove('show');
                elements.ageError.classList.remove('show');
                elements.genderError.classList.remove('show');
                elements.fitnessError.classList.remove('show');
                elements.activityError.classList.remove('show');
                
                // Validate weight
                const weight = parseFloat(elements.userWeight.value);
                if (!weight || weight < 30 || weight > 200) {
                    elements.weightError.classList.add('show');
                    isValid = false;
                } else {
                    userProfile.weight = weight;
                }
                
                // Validate age
                const age = parseInt(elements.userAge.value);
                if (!age || age < 15 || age > 100) {
                    elements.ageError.classList.add('show');
                    isValid = false;
                } else {
                    userProfile.age = age;
                }
                
                // Validate gender
                const gender = elements.userGender.value;
                if (!gender) {
                    elements.genderError.classList.add('show');
                    isValid = false;
                } else {
                    userProfile.gender = gender;
                }
                
                // Validate fitness level
                const fitnessLevel = elements.fitnessLevel.value;
                if (!fitnessLevel) {
                    elements.fitnessError.classList.add('show');
                    isValid = false;
                } else {
                    userProfile.fitnessLevel = fitnessLevel;
                }
                
                // Validate activity description
                const activity = elements.customActivity.value.trim();
                if (!activity) {
                    elements.activityError.classList.add('show');
                    isValid = false;
                }
                
                return isValid;
            }

            async function analyzeActivityWithAI() {
                if (!validateUserProfile()) {
                    alert('Please complete all required fields for accurate AI analysis');
                    return;
                }

                // Show loading state
                elements.analyzeBtn.disabled = true;
                elements.btnText.innerHTML = '<div class="loading-spinner"></div> Analyzing with AI...';

                try {
                    const activityDescription = elements.customActivity.value.trim();
                    
                    // Call Gemini AI for analysis
                    const aiResponse = await callGeminiAI(activityDescription, userProfile);
                    
                    // üõ°Ô∏è CRITICAL: Validate AI response before using it
                    const validatedResponse = validateAIResponse(aiResponse, userProfile, activityDescription);
                    
                    if (validatedResponse && validatedResponse.calories) {
                        currentCaloriesBurned = validatedResponse.calories;
                        currentActivityCategory = validatedResponse.activityType;
                        
                        // üéØ EXTRACT AI FOOD CATEGORIES
                        aiFoodCategories = parseAIFoodCategories(validatedResponse);
                        console.log('AI Food Categories:', aiFoodCategories);
                        
                        // Display results
                        displayAIResults(validatedResponse);
                    } else {
                        throw new Error('AI returned invalid data after validation');
                    }
                    
                } catch (error) {
                    console.error('AI Analysis Error:', error);
                    alert('AI analysis failed: ' + error.message);
                } finally {
                    // Reset button state
                    elements.analyzeBtn.disabled = false;
                    elements.btnText.textContent = 'Analyze with AI';
                }
            }

            function parseAIFoodCategories(aiResponse) {
                const defaultCategories = {
                    quick_energy: [],
                    protein_rich: [],
                    balanced: [],
                    full_meals: []
                };

                // üõ°Ô∏è BULLETPROOF PARSING - Handle any AI response format
                if (aiResponse.food_categories) {
                    return {
                        quick_energy: aiResponse.food_categories.quick_energy || [],
                        protein_rich: aiResponse.food_categories.protein_rich || [],
                        balanced: aiResponse.food_categories.balanced || [],
                        full_meals: aiResponse.food_categories.full_meals || []
                    };
                }
                
                // üõ°Ô∏è FALLBACK: If AI used old format
                if (aiResponse.food_recommendations && Array.isArray(aiResponse.food_recommendations)) {
                    // Distribute foods intelligently into categories
                    return distributeFoodsToCategories(aiResponse.food_recommendations);
                }
                
                return defaultCategories;
            }

            function distributeFoodsToCategories(foods) {
                const categories = {
                    quick_energy: [],
                    protein_rich: [],
                    balanced: [],
                    full_meals: []
                };

                foods.forEach(food => {
                    const name = (food.name || '').toLowerCase();
                    const rationale = (food.rationale || '').toLowerCase();
                    
                    if (name.includes('banana') || name.includes('date') || name.includes('sports drink') || 
                        rationale.includes('quick') || rationale.includes('immediate') || rationale.includes('fast')) {
                        categories.quick_energy.push(food);
                    } else if (name.includes('protein') || name.includes('chicken') || name.includes('yogurt') || 
                               name.includes('egg') || rationale.includes('muscle') || rationale.includes('protein')) {
                        categories.protein_rich.push(food);
                    } else if (name.includes('bowl') || name.includes('meal') || name.includes('dinner') || 
                               rationale.includes('complete') || rationale.includes('full meal')) {
                        categories.full_meals.push(food);
                    } else {
                        categories.balanced.push(food);
                    }
                });

                return categories;
            }

            function validateAIResponse(aiResponse, userProfile, activityDescription) {
                // üö® SANITY CHECK 1: Calories exist and are reasonable
                if (!aiResponse.calories || aiResponse.calories <= 0) {
                    throw new Error('AI returned invalid calorie data');
                }
                
                // üö® SANITY CHECK 2: Estimate activity duration for calorie/hour check
                const estimatedMinutes = estimateActivityMinutes(activityDescription);
                const caloriesPerHour = (aiResponse.calories / estimatedMinutes) * 60;
                
                // Human limits: nobody burns over 1200 calories/hour in normal exercise
                if (caloriesPerHour > 1200) {
                    console.warn('AI returned unrealistic calories per hour:', caloriesPerHour);
                    throw new Error('AI returned unrealistic calorie estimate for this activity');
                }
                
                // üö® SANITY CHECK 3: Minimum calories for any activity
                if (aiResponse.calories < 10) {
                    throw new Error('AI returned unrealistically low calories');
                }
                
                // üö® SANITY CHECK 4: Macronutrients add up to ~100%
                if (aiResponse.macronutrients) {
                    const total = aiResponse.macronutrients.carbs + aiResponse.macronutrients.protein + aiResponse.macronutrients.fat;
                    if (total < 80 || total > 120) {
                        // Reset to sensible defaults
                        aiResponse.macronutrients = {carbs: 55, protein: 25, fat: 20};
                    }
                }
                
                return aiResponse;
            }

            function estimateActivityMinutes(activityDesc) {
                const timeMatch = activityDesc.match(/(\d+)\s*(min|minute|hour|hr)/i);
                if (timeMatch) {
                    const num = parseInt(timeMatch[1]);
                    const unit = timeMatch[2].toLowerCase();
                    return unit.includes('hour') ? num * 60 : num;
                }
                return 30; // Default 30 minutes if no time specified
            }

            async function callGeminiAI(activityDescription, userProfile) {
                // Check if API key is configured
                if (!GEMINI_API_KEY || GEMINI_API_KEY === '') {
                    throw new Error('Please configure your Gemini API key. Get a FREE key from: https://aistudio.google.com/');
                }

                // ‚úÖ CORRECTED ENDPOINT - Using gemini-2.0-flash instead of deprecated 1.0-pro
                const GEMINI_URL = `https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const prompt = `
CRITICAL: Use EXACT calculations based on user profile. DO NOT estimate generally.

USER PROFILE (MUST USE THESE EXACT NUMBERS):
- Weight: ${userProfile.weight} kg - DIRECTLY AFFECTS CALORIE BURN
- Age: ${userProfile.age} years - AFFECTS METABOLISM  
- Gender: ${userProfile.gender} - AFFECTS CALORIE CALCULATIONS
- Fitness Level: ${userProfile.fitnessLevel} - AFFECTS INTENSITY & RECOVERY

ACTIVITY: "${activityDescription}"

CALORIE CALCULATION RULES:
- Base metabolic rate adjustment for age/gender
- Weight-based calorie burn: heavier people burn more
- Fitness level intensity adjustment
- MAXIMUM calories per hour: 1000 for extreme exercise

CALORIE RANGE SANITY CHECK:
- Light activity: 150-300 calories/hour
- Moderate: 300-500 calories/hour  
- Intense: 500-800 calories/hour
- Extreme: 800-1000 calories/hour

CRITICAL: You MUST return foods in EXACT 4 categories:

1. ‚ö° QUICK ENERGY: Fast-digesting carbs, immediate consumption (1-hour)
2. üí™ PROTEIN RICH: High-protein foods, muscle repair focus (1-2 hours)  
3. ‚öñÔ∏è BALANCED: Good carb-protein-fat ratio, within 2 hours
4. üçΩÔ∏è FULL MEALS: Complete meals, next proper meal (2+ hours)

FOOD FORMAT PER CATEGORY:
- 3-5 foods per category
- Each food: name, calories, timing, rationale, emoji
- NO MISSING CATEGORIES

EXACT JSON RESPONSE REQUIRED:
{
    "calories": calculated_number_using_above_rules,
    "activityType": "light|moderate|intense|extreme",
    "analysis": "Detailed analysis using user profile data",
    "macronutrients": {"carbs": 50-70, "protein": 15-30, "fat": 15-25},
    "food_categories": {
        "quick_energy": [
            {
                "name": "Banana",
                "calories": 105,
                "timing": "immediate",
                "rationale": "Fast-digesting carbs replenish muscle glycogen quickly",
                "emoji": "üçå"
            }
        ],
        "protein_rich": [
            {
                "name": "Greek Yogurt with Berries",
                "calories": 150,
                "timing": "1-hour",
                "rationale": "High-quality protein for muscle repair with antioxidants",
                "emoji": "ü•õü´ê"
            }
        ],
        "balanced": [
            {
                "name": "Turkey Sandwich",
                "calories": 320,
                "timing": "2-hours",
                "rationale": "Balanced macros for sustained energy and recovery",
                "emoji": "ü•™"
            }
        ],
        "full_meals": [
            {
                "name": "Salmon with Sweet Potato & Vegetables",
                "calories": 450,
                "timing": "next-meal",
                "rationale": "Complete meal with omega-3s and complex carbs for full recovery",
                "emoji": "üêüüç†"
            }
        ]
    }
}

Be realistic and practical in your recommendations.
`;

                try {
                    console.log('üöÄ Making API call to Gemini...');
                    
                    const response = await fetch(GEMINI_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.1,
                                maxOutputTokens: 2000,
                            }
                        })
                    });

                    console.log('üì° Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå API Error:', errorText);
                        throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('‚úÖ AI Response received');
                    
                    if (!data.candidates || !data.candidates[0].content.parts[0].text) {
                        throw new Error('Invalid response format from AI');
                    }
                    
                    const responseText = data.candidates[0].content.parts[0].text;
                    console.log('üìù Raw AI Response:', responseText);
                    
                    // Extract JSON from response
                    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in AI response');
                    }
                } catch (error) {
                    console.error('‚ùå Gemini API Error:', error);
                    throw error;
                }
            }

            function displayAIResults(aiResponse) {
                elements.caloriesBurned.textContent = aiResponse.calories;
                elements.caloriesResult.style.display = 'block';
                elements.aiAnalysis.classList.add('active');
                
                // Display AI analysis
                elements.aiRecommendation.textContent = aiResponse.analysis;
                
                // Display macronutrient breakdown
                const macros = aiResponse.macronutrients || {carbs: 50, protein: 30, fat: 20};
                elements.macroBreakdown.innerHTML = `
                    <div class="macro-item">
                        <div class="macro-dot macro-carbs"></div>
                        <span>Carbs: ${macros.carbs}%</span>
                    </div>
                    <div class="macro-item">
                        <div class="macro-dot macro-protein"></div>
                        <span>Protein: ${macros.protein}%</span>
                    </div>
                    <div class="macro-item">
                        <div class="macro-dot macro-fat"></div>
                        <span>Fat: ${macros.fat}%</span>
                    </div>
                `;
                
                elements.caloriesResult.scrollIntoView({behavior: 'smooth', block: 'start'});
            }

            function showPersonalizationPanel() {
                if (currentCaloriesBurned === 0) {
                    alert('Please analyze your activity first');
                    return;
                }
                
                elements.personalizationPanel.style.display = 'block';
                elements.personalizationPanel.scrollIntoView({behavior: 'smooth', block: 'start'});
            }

            function applyPersonalizationAndShowFoods() {
                // Get user preferences
                userPreferences.dietary = elements.dietaryPreference.value;
                userPreferences.timing = elements.eatingTiming.value;
                userPreferences.goal = elements.foodGoal.value;
                
                // Calculate replenishment calories
                const goal = elements.weightGoal.value;
                const replenishPercent = parseInt(elements.replenishPercent.value);
                
                let adjustmentFactor = 1.0;
                switch(goal) {
                    case 'loss': adjustmentFactor = 0.8; break;
                    case 'maintenance': adjustmentFactor = 1.0; break;
                    case 'gain': adjustmentFactor = 1.2; break;
                }
                
                currentReplenishmentCalories = Math.round(
                    currentCaloriesBurned * (replenishPercent / 100) * adjustmentFactor
                );
                
                elements.foodHeader.textContent = currentReplenishmentCalories;
                elements.foodRecommendations.style.display = 'block';
                
                // Show the first category by default
                renderFoodCategory('quick-energy');
                
                elements.foodRecommendations.scrollIntoView({behavior: 'smooth', block: 'start'});
            }

            function renderFoodCategory(category) {
                elements.foodResults.innerHTML = '';
                
                const categoryMap = {
                    'quick-energy': { 
                        title: '‚ö° Quick Energy', 
                        data: aiFoodCategories.quick_energy 
                    },
                    'protein': { 
                        title: 'üí™ Protein Rich', 
                        data: aiFoodCategories.protein_rich 
                    },
                    'balanced': { 
                        title: '‚öñÔ∏è Balanced', 
                        data: aiFoodCategories.balanced 
                    },
                    'full-meals': { 
                        title: 'üçΩÔ∏è Full Meals', 
                        data: aiFoodCategories.full_meals 
                    }
                };
                
                const config = categoryMap[category];
                if (!config) return;
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'food-category';
                
                const title = document.createElement('div');
                title.className = 'food-category-title';
                title.innerHTML = config.title;
                if (userPreferences.dietary !== 'any' || userPreferences.timing !== 'immediate' || userPreferences.goal !== 'recovery') {
                    title.innerHTML += ' <span class="personalization-badge">PERSONALIZED</span>';
                }
                categoryDiv.appendChild(title);
                
                if (config.data && config.data.length > 0) {
                    config.data.forEach(food => {
                        if (!food.name || !food.calories) {
                            console.warn('Invalid food item from AI:', food);
                            return;
                        }
                        
                        const scale = currentReplenishmentCalories / food.calories;
                        const scaledCalories = Math.round(food.calories * scale);
                        const displayName = scale > 1.3 ? `Large ${food.name}` : scale < 0.7 ? `Small ${food.name}` : food.name;
                        
                        const foodItem = document.createElement('div');
                        foodItem.className = 'food-item';
                        foodItem.innerHTML = `
                            <div>
                                <div>${food.emoji || 'üçΩÔ∏è'} ${displayName}</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                    <strong>Timing:</strong> ${food.timing || 'Within 1 hour'} | 
                                    <strong>Why:</strong> ${food.rationale || 'Optimal recovery nutrition'}
                                </div>
                            </div>
                            <div>${scaledCalories} kcal</div>
                        `;
                        categoryDiv.appendChild(foodItem);
                    });
                } else {
                    const description = document.createElement('div');
                    description.style.fontSize = '14px';
                    description.style.color = 'var(--text-secondary)';
                    description.style.marginBottom = '16px';
                    description.style.textAlign = 'center';
                    description.style.padding = '20px';
                    description.textContent = `No AI food recommendations available for ${config.title}. Try analyzing your activity again with more details.`;
                    categoryDiv.appendChild(description);
                }
                
                elements.foodResults.appendChild(categoryDiv);
            }

            function handleCategoryFilter(e) {
                if (e.target.classList.contains('category-tag')) {
                    document.querySelectorAll('.category-tag').forEach(tag => {
                        tag.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    renderFoodCategory(e.target.dataset.category);
                }
            }

            function clearAll() {
                // Clear all inputs and reset state
                elements.userWeight.value = '';
                elements.userAge.value = '';
                elements.userGender.value = '';
                elements.fitnessLevel.value = '';
                elements.customActivity.value = '';
                elements.weightGoal.value = 'maintenance';
                elements.replenishPercent.value = '75';
                elements.dietaryPreference.value = 'any';
                elements.eatingTiming.value = 'immediate';
                elements.foodGoal.value = 'recovery';
                
                // Hide panels
                elements.personalizationPanel.style.display = 'none';
                elements.aiAnalysis.classList.remove('active');
                elements.caloriesResult.style.display = 'none';
                elements.foodRecommendations.style.display = 'none';
                
                // Reset data
                currentCaloriesBurned = 0;
                currentReplenishmentCalories = 0;
                currentActivityCategory = null;
                userProfile = {};
                userPreferences = {
                    dietary: 'any',
                    timing: 'immediate',
                    goal: 'recovery',
                    allergies: []
                };
                aiFoodCategories = {
                    quick_energy: [],
                    protein_rich: [],
                    balanced: [],
                    full_meals: []
                };
                
                // Reset category tags
                document.querySelectorAll('.category-tag').forEach(tag => {
                    tag.classList.remove('active');
                });
                document.querySelector('.category-tag[data-category="quick-energy"]').classList.add('active');
                
                // Reset errors
                elements.weightError.classList.remove('show');
                elements.ageError.classList.remove('show');
                elements.genderError.classList.remove('show');
                elements.fitnessError.classList.remove('show');
                elements.activityError.classList.remove('show');
            }

            document.addEventListener('DOMContentLoaded', initApp);
        })();
    </script>